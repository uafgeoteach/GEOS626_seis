% dvips -t letter lab_seismo_rs.dvi -o lab_seismo_rs.ps ; ps2pdf lab_seismo_rs.ps
%
% FIGURES GENERATED WITH THE FOLLOWING SETTINGS IN plotw_rs.m (2017-11-01)
% bprint_record_section = true;
% odir = '/home/carltape/classes/appliedseis/homework/figures/';
% otag = 'geos626';
% bprint_map = true;
%
\documentclass[11pt,titlepage,fleqn]{article}

\input{hw626_header}

% change the figures to ``Figure L3'', etc
\renewcommand{\thefigure}{L\arabic{figure}}
\renewcommand{\thetable}{L\arabic{table}}
\renewcommand{\theequation}{L\arabic{equation}}
\renewcommand{\thesection}{L\arabic{section}}

%\newcommand{\tfile}{{\tt run\_getwaveform\_626.ipynb}}
\newcommand{\tfile}{{\tt lab\_seismo\_rs.ipynb}}

%--------------------------------------------------------------
\begin{document}
%-------------------------------------------------------------

\begin{spacing}{1.2}
\centering
{\large \bf Lab Exercise: Analyzing seismic data in record sections [seismo\_rs]} \\
\cltag\ \\
Last compiled: \today
\end{spacing}

%------------------------

\subsection*{Instructions}

\begin{itemize}
\item The purpose of this lab is to create several different plots of seismic record sections. A seismic record section is a series of seismograms that is plotted in some particular order. Typically the $x$-axis is time, and then the seismograms are separated in the $y$-direction and ordered by source-station distance or source-station azimuth.

The bandpass filter that is applied to the seismograms can have a dramatic effect on what is visible. The frequency limits of the bandpass is one of several important choices that are needed when plotting record sections.

\item This lab uses ObsPy to access seismic waveforms from the IRIS Data Management Center. See {\tt lab\_response.pdf}.

\item WARNING: This lab is in a state of transition from Matlab to Python.

%\item This lab uses the GISMO Waveform Suite for Matlab; see \verb+lab_response.pdf+ for details.

%\item The seismic waveforms are stored at the Alaska Earthquake Center. AEC receives waveforms from all stations in Alaska, as well as all global stations from the Global Seismic Network (GSN = networks II + IU). Because most of the waveforms are from Alaska, most of the examples are from events from Alaska.

%Most waveforms here are also available from the IRIS Data Management Center.

%------------------------

\end{itemize}

%-------------------------------------------------------------

%\pagebreak
\subsection*{Exercises}

%-----------
\begin{enumerate}
%-----------

\item Open \tfile\ and \verb+plotw_rs.py+.
%
\begin{enumerate}
\item Run \tfile\ to produce the map in \refFig{fig:map_ex01} and the record section in \refFig{fig:rs_ex01}. \\
{\bf Spend some time to understand the two key parts}: \\
(1) waveform extraction, (2) plotting a record section.

What input variables are needed to specify the bandpass? \\
How is a bandpass filter applied within \verb+plotw_rs.py+? \\
What input variables are needed to specify the bandpass?

\item What does the spectrogram show? Try changing the station and other input parameters.

\end{enumerate}

%---------------

\item Try the rest of the examples in \tfile. Here are some questions for each example
%
\begin{itemize}
\item Example 1: calving event at Yahtse glacier. 

Zoom in on the station map to see the source--station geometry.

Describe some oddities within the record section.

Describe the characteristics of this signal, which was recorded only 1~km from the event. Do you see a distinct P wave on any seismogram? (This will be clearer later, after you have seen P waves from normal earthquakes.)

\item Example 2: near-source recordings of \magw{7.5} earthquake in SE Alaska. 

What happened to these seismograms?

\item Example 3: explosion in Fairbanks. 

There are two signals that appear at most stations. \\
Start by examining the station MDM (Murphy Dome).

There is only one source, so how can you explain both signals in terms of their travel times and amplitudes?

\item Example 4: very low frequency earthquake near Denali. 

Estimate the dominant frequency of this event? (Hint: use the spectrogram tool.)

\item Example 5: landslide near Lituya. 

What is the dominant frequency of this event?

\item Example 6: Sumatra \magw{8.6} triggering earthquakes in Alaska. 
%
\begin{itemize}
\item Examine the record section and try to determine what you see.
\item For each event (which we define as a signal that appears on several stations), determine what the closest station is. Where did each event occur?
\item Change the bandpass period range (\verb+T1+ and \verb+T2+) for the record section plot to be \trange{2}{1000}, so that you see the complete frequency range of this waveform. \\
Approximately how long did this earthquake last in Alaska?
\end{itemize}

\item Example 7: other earthquakes during the Sumatra \magw{8.6} earthquake in Alaska.

You are given the source parameters for three earthquakes that occurred in Alaska during the ground motion of the main wavetrain from the Sumatra \magw{8.6} earthquake.

For each possibly triggered event, enter the following information in \refTab{tab:triggered}.
%
\begin{itemize}
\item the closest station (and the distance in km)
\item the suspicious stations
\item the widest period range over which the signal is clearly visible. This can be achieved by varying \verb+T1+ and \verb+T2+ when calling \verb+plotw_rs()+: you do not need to re-extract the waveforms.
\end{itemize}
%
\begin{table}[h]
\centering
\caption[]
{{
Possibly triggered earthquakes during the 2012 Sumatra \magw{8.6} earthquake in Alaska. List the basnpass range that you used to make your assessments.
\label{tab:triggered}
}}
\begin{spacing}{1.5}
\begin{tabular}{||l|c|c|c|c||}
\hline
earthquake & suspicious stations & closest & distance & bandpass \\
           &  &  station & km & period range \\ \hline\hline
Nenana & & & & \\ \hline
Andreanof & & & & \\ \hline
Iliamna & & & & \\ \hline
\end{tabular}
\end{spacing}
\end{table}

%---------------
\end{itemize}
%---------------

\item Now play around with changing any of the parameters: waveform extraction, plotting record sections, making spectrograms. Or take a look at any event in the Alaska Earthquake Center catalog (see Recent Earthquakes website).

\end{enumerate}

%-------------------------------------------------------------
%\bibliography{carl_abbrev,carl_main,carl_source,carl_him,carl_alaska}

%-------------------------------------------------------------

%-------------------------------------------------------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20100918141502000_geos626_map}
\caption[]
{{
Map of stations for Example 2 (\refFig{fig:rs_ex01}).
}}
\label{fig:map_ex01}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=17.5cm]{rs_20100918141502000_geos626_p01}
\caption[]
{{
Record section produced from Example 1.
The record section shows filtered (\frange{0.5}{10.0}) vertical-component waveforms for all stations within 200~km of the event.
}}
\label{fig:rs_ex01}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{BOOMspec_geos626}
\caption[]
{{
Spectrogram for a seismogram in \tfile.
}}
\label{fig:BOOM}
\end{figure}

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20130105085832400_geos626_map}
\caption[]
{{
Map of stations for Example 2 (\refFig{fig:rs_ex02}).
}}
\label{fig:map_ex02}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=18cm]{rs_20130105085832400_geos626_p01}
\caption[]
{{
Record section produced from Example 2.
The record section shows filtered (\frange{1}{5}) vertical-component waveforms for all stations within 200~km of the event.
}}
\label{fig:rs_ex02}
\end{figure}

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20130203011031495_geos626_map}
\caption[]
{{
Map of stations for Example 3 (\refFig{fig:rs_ex03}).
}}
\label{fig:map_ex03}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=17.5cm]{rs_20130203011031495_geos626_p01}
\caption[]
{{
Record section produced from Example 3.
The record section shows unfiltered three-component waveforms for all stations within 500~km of the event.
}}
\label{fig:rs_ex03}
\end{figure}

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20140122121434000_geos626_map}
\caption[]
{{
Map of stations for Example 4 (\refFig{fig:rs_ex04}).
}}
\label{fig:map_ex04}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=17.5cm]{rs_20140122121434000_geos626_p01}
\caption[]
{{
Record section produced from Example 4.
The record section shows high-pass-filtered ($f \ge 0.5$~Hz) vertical-component waveforms for all stations within 200~km of the event.
}}
\label{fig:rs_ex04}
\end{figure}

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20140216142400000_geos626_map}
\caption[]
{{
Map of stations for Example 5 (\refFig{fig:rs_ex05}).
}}
\label{fig:map_ex05}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1cm}
\includegraphics[width=17cm]{rs_20140216142400000_geos626_p01}
\caption[]
{{
Record section produced from Example 5 (continued on following two pages).
The record section shows filtered (\trange{10}{40}) vertical-component waveforms for all stations within 200~km of the event.
}}
\label{fig:rs_ex05}
\end{figure}

\clearpage\pagebreak
\hspace{-1.25cm}
\includegraphics[width=17cm]{rs_20140216142400000_geos626_p02} \\
\refFig{fig:rs_ex05}, p.~2

\clearpage\pagebreak
\hspace{-1.25cm}
\includegraphics[width=17cm]{rs_20140216142400000_geos626_p03} \\
\refFig{fig:rs_ex05}, p.~3

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_201204110838A_geos626_map}
\caption[]
{{
Map of stations for Example 6 (\refFig{fig:rs_ex06}).
}}
\label{fig:map_ex06}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=17.5cm]{rs_201204110838A_geos626_p01}
\caption[]
{{
Record section produced from Example 6.
The record section shows filtered (\frange{2}{4}) vertical-component waveforms for all stations within $25^\circ$ of the point with longitude-latitude coordinates $(-148.9461^\circ, 64.9222^\circ)$. Each red lines marks the origin time of an earthquake.
}}
\label{fig:rs_ex06}
\end{figure}

%-----------------

\clearpage\pagebreak
\begin{figure}
\centering
\includegraphics[width=16cm]{rs_20120411092157440_geos626_map}
\caption[]
{{
Map of stations for Example 7 (\refFig{fig:rs_ex07}).
}}
\label{fig:map_ex07}
\end{figure}

\clearpage\pagebreak
\begin{figure}
\hspace{-1.25cm}
\includegraphics[width=17.5cm]{rs_20120411092157440_geos626_p01}
\caption[]
{{
Record section produced from Example 7.
The record section shows filtered (\frange{2}{4}) vertical-component waveforms for all stations within 200~km of the event.
}}
\label{fig:rs_ex07}
\end{figure}

%==============================================

\iffalse

\appendix

\clearpage\pagebreak

\section{{\tt run\_getwaveform\_626.m}}
\label{sec:script}

\small
\begin{spacing}{1.0}
\begin{verbatim}
spdy = 86400;

% default parameters for plotting record sections
% note: you can over-ride these within each example below
rssort = 2;      % =1 by azimuth, =2 by distance
iabs = 0;
T1 = [];
T2 = [];
trshift = 0;
tmark = [];
pmax = 50;

iintp = 0;
inorm = 1;
nfac = 1;
azstart = [];
iunit = 1;
tlims = [];     % time limits for plotting
imap = 1;

%========================================

% default parameters for waveform extraction
samplerate = [];
cutoff = [];

% USER CHANGE THIS OR ADD YOUR OWN EXAMPLE
iex = 1;

switch iex
    case 1
        % Yahtse event recorded within two databases (AEC, Yahtse)
        %idatabase = 5; stasub = [-141.489 -141.377 60.205 60.245];
        idatabase = [1 5]; stasub = [0 200];

        % source parameters (some can be empty)
        originTime = datenum('2010/09/18 14:15:02');
        elat = 60.155496;
        elon = -141.378343;
        edep_km = 0;
        eid = [];
        mag = [];

        chan = {'HHZ','BHZ'};

        duration_s = 70;
        oshift = 20;
        T1 = 0.1;
        T2 = 2;

    case 2
        % Mw 7.5 SE Alaska
        idatabase = 1; stasub = [0 500];
        % source parameters (some can be empty)
        originTime = datenum('2013/01/05 08:58:32.4');
        elat = 55.62;
        elon = -135.13;
        edep_km = 0;
        eid = [];
        mag = [];
        % broadband channels
        chan1 = {'BHZ','BHE','BHN','BH1','BH2'};
        % strong motion channels
        chan2 = {'BNZ','BNE','BNN','BN1','BN2','BLZ','BLE','BLN','BL1','BL2',...
            'HNZ','HNE','HNN','HN1','HN2','HLZ','HLE','HLN','HL1','HL2'};
        % warning: waveforms will have different units (nm/s, nm/s^2)
        chan = [chan1 chan2];
        duration_s = 300;
        oshift = 50;
        
    case 3
        % explosion in Fairbanks
        idatabase = 1;
        % source parameters (some can be empty)
        originTime = datenum('2013/02/03 01:10:31.495');
        %elat = 64.8156; elon = -147.9419;  % original AEC
        %elat = 64.8045; elon = -147.9653;  % reviewed AEC
        elat = 64.80175; elon = -147.98236; % infrasound
        edep_km = 0;
        eid = [];
        mag = [];
        % broadband channels
        chan = {'SHZ','HHZ','BHZ'};
        stasub = [0 200];
        duration_s = stasub(2)/0.30;  % air wave
        oshift = 50;
        % record section
        T1 = 0.2;
        T2 = 1;
        
    case 4
        % very low frequency (VLF) event near Kantishna
        idatabase = 1;
        % source parameters (some can be empty)
        originTime = datenum('2014/01/22 12:14:34');
        elat = 63.463; elon = -150.109;
        edep_km = 38;
        eid = [];
        mag = 1.7;
        % broadband channels
        chan = {'BHZ'};
        stasub = [0 200];
        duration_s = 100; 
        oshift = 0;
        T1 = []; T2 = 2;
        
    case 5
        % landslide near Lituya
        idatabase = 1; stasub = [0 1000];
        % source parameters (some can be empty)
        %originTime = datenum('2010/09/18 14:15:02');
        originTime = datenum('2014/02/16 14:24:00');
        elat = 58.68;
        elon = -137.37;
        edep_km = 0;
        eid = [];
        mag = [];
        chan = {'BHZ'};  % consider HHZ as well
        duration_s = 600;
        oshift = 0;
        T1 = 10; T2 = 40;
        pmax = 40;
        
    case 6
        % Sumatra Mw 8.6 in Alaska and triggered earthquakes
        idatabase = 1;
        % four different events
        originTimeS = datenum('2012/04/11 08:38:37.30');    % Sumatra (CMT-PDE)
        originTimeA = datenum('2012/04/11 09:00:09.71');    % Andreanof (NEIC)
        originTimeN = datenum('2012/04/11 09:21:57.44');    % Nenana (NEIC)
        originTimeI = datenum('2012/04/11 09:40:58.02');    % Iliamna slab (NEIC)
        elatS = 2.24; elonS = 92.78; edepS = 40.03; emagS = 8.6;
        elatA = 51.36; elonA = -176.10; edepA = 20; emagA = 5.5;
        elatN = 64.9222; elonN = -148.9461; edepN = 19.4; emagN = 3.88;
        elatI = 60.10; elonI = -152.83; edepI = 101; emagI = 2.9;
        
        % source
        elat = elatS; elon = elonS; edep_km = edepS; mag = emagS;
        eid = '201204110838A';  % GCMT
        originTime = originTimeS;
        chan = {'BHZ'};
        dmax_deg = 25;
        stasub = [elonN elatN 0 dmax_deg 0 360];

        % parameters for Sumatra waveforms across Alaska
        duration_s = 3600*2.0;
        oshift = 3600*0.25;
        T1 = 1/4; T2 = 1/2;     % P wave + triggered events
        %T1 = 2; T2 = 1000;     % full wavetrain (no triggered events visible)
        iunit = 2;
        % three different triggered events are visible
        tmark = [originTimeA originTimeN originTimeI];
        
    case 7
        % one of the triggered earthquakes
        idatabase = 1;
        % four different events
        originTimeS = datenum('2012/04/11 08:38:37.30');    % Sumatra (CMT-PDE)
        originTimeA = datenum('2012/04/11 09:00:09.71');    % Andreanof (NEIC)
        originTimeN = datenum('2012/04/11 09:21:57.44');    % Nenana (NEIC)
        originTimeI = datenum('2012/04/11 09:40:58.02');    % Iliamna slab (NEIC)
        elatS = 2.24; elonS = 92.78; edepS = 40.03; emagS = 8.6;
        elatA = 51.36; elonA = -176.10; edepA = 20; emagA = 5.5;
        elatN = 64.9222; elonN = -148.9461; edepN = 19.4; emagN = 3.88;
        elatI = 60.10; elonI = -152.83; edepI = 101; emagI = 2.9;
        
        % source
        originTime = originTimeN; elat = elatN; elon = elonN; edep_km = edepN; mag = emagN; stasub = [0 200];   % Nenana
        %originTime = originTimeA; elat = elatA; elon = elonA; edep_km = edepA; mag = emagA; stasub = [0 2000];   % Andreanof
        %originTime = originTimeI; elat = elatI; elon = elonI; edep_km =edepI; mag = emagI; stasub = [0 400];   % Iliamna
        eid = [];
        chan = {'BHZ'};

        % parameters for triggered waveforms across Alaska
        duration_s = 200; oshift = 10; T1 = 1/4; T2 = 1/2;    % Nenana
        %duration_s = 600; oshift = 10; T1 = 1/4; T2 = 1/2;    % Andreanof
        %duration_s = 200; oshift = 10; T1 = 1/4; T2 = 1/2;    % Iliamna
        
end

% tshift (and trshift) are for plotting record sections only
tshift = oshift + trshift;

%startTime = originTime - max(oshift)/spdy;
startTime = originTime - oshift/spdy;
endTime   = originTime + duration_s/spdy;
dur_dy = endTime-startTime;
fprintf('origin time is %s\n',datestr(originTime,'yyyy-mm-dd HH:MM:SS.FFF'))
fprintf('startTime is %s\n',datestr(startTime,31));
fprintf('total length of time requested: %.2f s (= %.2f min = %.2f hours)\n',...
    dur_dy*spdy,dur_dy*3600,dur_dy*24);

%==========================================================================

% additional user parameters
%sacdir = './';      % =[] to return waveform object only
sacdir = [];
iint = 0;            % integrate waveforms: =1 for displacement, =0 for velocity
iprocess = 1;        % iprocess = 2 to deconvolve
irs = 1;

% get waveform object (optional: write sac files to a directory)
tic
[w,s,site,sitechan] = getwaveform(idatabase,startTime,endTime,chan,iint,iprocess,cutoff,samplerate,stasub,sacdir,originTime,elat,elon,edep_km,mag,eid);
toc
disp(sprintf('%.1f s to execute getwaveform.m from run_getwaveform_short.m',toc));

%--------------------------------------------------------------------------
% FROM HERE ON OUT, PLOTTING AND CHECKING ONLY

whos w s site sitechan

% check indexing and units
for ii=1:length(w)
   disp(sprintf('%3i %7s %3s %6s %6s %6s %10s %6i sps',ii,get(w(ii),'channel'),get(w(ii),'KNETWK'),...
       get(w(ii),'station'),char(site(ii).sta),char(sitechan(ii).sta),get(w(ii),'units'),get(w(ii),'freq')));
end

% plot record section
if and(irs==1,~isempty(w))
    % assume all waveforms have the same event ID
    keid = get(w(1),'KEVNM');

    % plot record section
    % note: these can be printed to file by setting iprint=1 in plotw_rs.m
    plotw_rs(w,rssort,iabs,tshift,tmark,T1,T2,pmax,iintp,inorm,tlims,nfac,azstart,iunit,imap);
end

%--------------------------------------------------------------------------
% ANALYZE INDIVIDUAL RECORDS

break

% subset of stations
stasubset = {'BOOM'};       % use BOOM with example 1
wsubset = wkeep(w,stasubset);

% enter the following settings
% 1. click AutoUpdate
% 2. slide Freq Max to the maximum
% 3. set NFFT to 256
% 4. set OVERLAP to 80%
% 5. set MIN 42
% 6. set MAX 112
% 7. from the tab at top, Plot --> Specgram2
% WHEN YOU ARE DONE OR IF YOU WANT TO MAKE A NEW PLOT, CLOSE THE FIGURE
figure; uispecgram(wsubset(1));     % will only work for a single 

% in case you want to analyze the filtered version that you see in the
% record section, you can return wfilt
[isort,wfilt] = plotw_rs(w,rssort,iabs,tshift,tmark,T1,T2,pmax,iintp,inorm,tlims,nfac,azstart,iunit,imap);
get(w,'station')
get(wfilt,'station')
get(wfilt(isort),'station')
get(wfilt,'station')
% plot kth station that appears in the ORDERED record section
kk = 1;     % order 
% plot that single record
figure; plot(wfilt(isort(kk)));
\end{verbatim}
\end{spacing}

\fi

%-------------------------------------------------------------
\end{document}
%-------------------------------------------------------------
